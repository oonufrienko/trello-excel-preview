<script>
    const t = window.TrelloPowerUp.iframe();

    t.render(async () => {
        try {
            // Отримуємо параметри з signed URL
            const args = await t.args();
            const attachmentId = args.attachmentId;

            if (!attachmentId) {
                throw new Error('ID файлу не передано.');
            }

            const context = t.getContext();
            const cardId = context.card;

            // Отримуємо attachment
            const card = await t.card('attachments');
            const attachment = card.attachments.find(a => a.id === attachmentId);

            if (!attachment) {
                throw new Error('Файл не знайдено в карточці.');
            }

            // Завантажуємо через Trello API
            const downloadUrl = `https://api.trello.com/1/cards/${cardId}/attachments/${attachmentId}/download`;
            const arrayBuffer = await t.get(downloadUrl, 'arrayBuffer');

            if (!arrayBuffer || arrayBuffer.byteLength === 0) {
                throw new Error('Файл порожній.');
            }

            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            let html = '';
            workbook.SheetNames.forEach(sheetName => {
                html += `<h3>${sheetName}</h3>`;
                html += XLSX.utils.sheet_to_html(workbook.Sheets[sheetName]);
            });

            document.getElementById('preview-container').innerHTML = html;
            t.sizeTo('#preview-container').catch(() => t.sizeTo(600));

        } catch (error) {
            console.error('Preview error:', error);
            showError('Помилка: ' + error.message);
        }
    });

    function showError(msg) {
        document.getElementById('preview-container').innerHTML = `<p style="color:red;">${msg}</p>`;
        t.sizeTo('#preview-container');
    }
</script>
